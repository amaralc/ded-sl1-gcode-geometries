;Author: Calil Amaral
;Description: Template program based on Adriano's laser shot program
;V:2020.05.21

;General Configurations-----------------------------------
$AC_TIMER[1]=0	    ; START TIMER
G91		              ; RELATIVE COORDINATES
G71		              ; METRIC SYSTEM
G64		              ; CONTINUOUS PATH MODE
M55		              ; MOVE LASER MIRROR TO HOME
G4F4		            ; DELAY 4 SECONDS
M0	   	            ; WAIT FOR USER INPUT

;R-Parameters----------------------------------------------
R0=39               ; LASER POWER
R1=300              ; FEED RATE PROCESS ON [mm/min]
R2=1000             ; FEED RATE PROCESS OFF [mm/min]
N20 R3=3            ; [RPM]
R4=0                ; COUNTER START
R5=64               ; NUMBER OF LAYERS
R6=1.44             ; DELTA Z

R8=0.1763           ; TAN THETA
R7=R6*R8            ; DELTA X
R9=3.2              ; BEAD THICKNESS
R10=0.1             ; OVERLAP [%]
R11=R9*(1-R10)      ; EFFECTIVE BEAD THICKNESS
R12=18              ; OUTER WALL MEAN RADIUS

R13=1.25            ; FIRST LAYER POWER FACTOR
R14=1.25            ; 1+N LAYER SPEED FACTOR
R15=R1              ; EFFECTIVE SPEED
R96=0               ; PRE-HEATING LAP COUTER
R97=2               ; PRE-HEATING NUMBER OF LAPS
R98=0               ; WALL COUNTER
R99=2               ; N OF WALLS

;Process Start-up------------------------------------------
M56		              ; SET CHANNEL 1 AS LASER SOURCE
G4F4		            ; DELAY 4 SECONDS TO POSITION THE MIRROR
;M76            	  ; CROSSJET ON
M0	   	  	        ; WAIT FOR USER INPUT
 
;Laser On and Path-----------------------------------------
G54                 ; SET ORIGIN
G90                 ; SET ABSOLUTE COORDINATES RELATIVE TO ORIGIN
G1 X0 Y0 Z0 F=R2    ; MOVE TO ORIGIN
G1 Y18 F=R1         ; MOVE TO BEAD START POSITION

WHILE(R4<R5)

  IF(R4==0)
    H1=R0*R13
    R15=R1
  ELSE
    H1=R0
    R15=R1*R14
  ENDIF

  M78               ; GAS 1 ON
  M64		            ; CARRIER ON
  H2=R3	            ; SET POWDER FLOW
  M62		            ; POWDER MIXER ON
  M66		            ; POWDER FEED ON
  G4 F10	          ; DELAY FOR POWDER STABILIZATION

  G91 
  ID=1 WHEN $AC_TIMER[1]>=0 DO M50
  G2 X0 Y=(-2*R12) I0 J=(-R12) F=R15
  ID=1 WHEN $AC_TIMER[1]>=0 DO M51
  G1 Y=R11
  ID=1 WHEN $AC_TIMER[1]>=0 DO M50
  G2 X0 Y=0 I0 J=(R12-R11) F=R15
  ID=1 WHEN $AC_TIMER[1]>=0 DO M51
  G1 Y=-R11
  ID=1 WHEN $AC_TIMER[1]>=0 DO M50
  G2 X0 Y=(2*R12) I0 J=(R12) F=R15
  ID=1 WHEN $AC_TIMER[1]>=0 DO M51

  M65		            ; CARRIER OFF
  M63		            ; POWDER MIXER OFF
  M67		            ; POWDER FEED OFF
  M79               ; GAS 1 OFF
  
  G1 X=-R7  Z=R6 F1000
  M0  
  R4 = R4 + 1
  
ENDWHILE

;End of Program--------------------------------------------
M65		              ; CARRIER OFF
M63		              ; POWDER MIXER OFF
M67		              ; POWDER FEED OFF
;M77                ; CROSSJET OFF
M55		              ; HOME LASER RESSONATOR
G4 F3               ; DELAY
M79                 ; GAS 1 OFF
M30		              ; PROGRAM END

